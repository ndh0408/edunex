<% function renderStars(rating) { %>
  <% for (let i = 1; i <= 5; i++) { %>
    <% if (i <= rating) { %>
      <i class="fas fa-star text-warning"></i>
    <% } else if (i <= rating + 0.5) { %>
      <i class="fas fa-star-half-alt text-warning"></i>
    <% } else { %>
      <i class="far fa-star text-warning"></i>
    <% } %>
  <% } %>
<% } %>

<!-- Hero Carousel -->
<div id="heroCarousel" class="carousel slide home-slider mb-5" data-bs-ride="carousel">
  <div class="carousel-indicators">
    <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
    <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
    <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="2" aria-label="Slide 3"></button>
  </div>
  <div class="carousel-inner">
    <div class="carousel-item active" style="background-image: url('https://images.unsplash.com/photo-1483985988355-763728e1935b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1920&q=80');">
      <div class="carousel-caption">
        <h1>BỘ SƯU TẬP MÙA HÈ</h1>
        <p>Khám phá các xu hướng thời trang mới nhất cho mùa hè</p>
        <a href="/products?category=summer" class="btn btn-primary mt-3">Xem ngay</a>
      </div>
    </div>
    <div class="carousel-item" style="background-image: url('https://images.unsplash.com/photo-1441984904996-e0b6ba687e04?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1920&q=80');">
      <div class="carousel-caption">
        <h1>GIẢM GIÁ LÊN ĐẾN 50%</h1>
        <p>Ưu đãi đặc biệt cho khách hàng thành viên</p>
        <a href="/products?discount=true" class="btn btn-primary mt-3">Mua ngay</a>
      </div>
    </div>
    <div class="carousel-item" style="background-image: url('https://images.unsplash.com/photo-1445205170230-053b83016050?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1920&q=80');">
      <div class="carousel-caption">
        <h1>THỜI TRANG CÔNG SỞ</h1>
        <p>Sang trọng, lịch sự và chuyên nghiệp</p>
        <a href="/products?category=office" class="btn btn-primary mt-3">Khám phá</a>
      </div>
    </div>
  </div>
  <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
    <span class="visually-hidden">Previous</span>
  </button>
  <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
    <span class="carousel-control-next-icon" aria-hidden="true"></span>
    <span class="visually-hidden">Next</span>
  </button>
</div>

<!-- Categories -->
<section class="container mb-5">
  <h2 class="text-center mb-4">DANH MỤC SẢN PHẨM</h2>
  <div class="row g-4">
    <% if (categories && categories.length > 0) { %>
      <% categories.slice(0, 6).forEach(category => { %>
        <div class="col-6 col-md-4">
          <a href="/products?category=<%= category.slug %>" class="text-decoration-none">
            <div class="category-card">
              <img src="<%= category.image ? '/uploads/categories/' + category.image : 'https://via.placeholder.com/300x200?text=' + category.name %>" alt="<%= category.name %>">
              <div class="category-overlay">
                <h3 class="m-0"><%= category.name %></h3>
              </div>
            </div>
          </a>
        </div>
      <% }); %>
    <% } else { %>
      <!-- Default categories if no data -->
      <div class="col-6 col-md-4">
        <a href="/products?category=ao" class="text-decoration-none">
          <div class="category-card">
            <img src="https://images.unsplash.com/photo-1523381294911-8d3cead13475?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=300&q=80" alt="Áo">
            <div class="category-overlay">
              <h3 class="m-0">Áo</h3>
            </div>
          </div>
        </a>
      </div>
      <div class="col-6 col-md-4">
        <a href="/products?category=quan" class="text-decoration-none">
          <div class="category-card">
            <img src="https://images.unsplash.com/photo-1541099649105-f69ad21f3246?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=300&q=80" alt="Quần">
            <div class="category-overlay">
              <h3 class="m-0">Quần</h3>
            </div>
          </div>
        </a>
      </div>
      <div class="col-6 col-md-4">
        <a href="/products?category=vay" class="text-decoration-none">
          <div class="category-card">
            <img src="https://images.unsplash.com/photo-1551163943-3f7e29e5ed20?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=300&q=80" alt="Váy">
            <div class="category-overlay">
              <h3 class="m-0">Váy</h3>
            </div>
          </div>
        </a>
      </div>
      <div class="col-6 col-md-4">
        <a href="/products?category=giay" class="text-decoration-none">
          <div class="category-card">
            <img src="https://images.unsplash.com/photo-1542291026-7eec264c27ff?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=300&q=80" alt="Giày">
            <div class="category-overlay">
              <h3 class="m-0">Giày</h3>
            </div>
          </div>
        </a>
      </div>
      <div class="col-6 col-md-4">
        <a href="/products?category=tui" class="text-decoration-none">
          <div class="category-card">
            <img src="https://images.unsplash.com/photo-1584917865442-de89df76afd3?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=300&q=80" alt="Túi xách">
            <div class="category-overlay">
              <h3 class="m-0">Túi xách</h3>
            </div>
          </div>
        </a>
      </div>
      <div class="col-6 col-md-4">
        <a href="/products?category=phu-kien" class="text-decoration-none">
          <div class="category-card">
            <img src="https://images.unsplash.com/photo-1611591437281-460bfbe1220a?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=300&q=80" alt="Phụ kiện">
            <div class="category-overlay">
              <h3 class="m-0">Phụ kiện</h3>
            </div>
          </div>
        </a>
      </div>
    <% } %>
  </div>
</section>

<!-- Featured Products -->
<section class="container mb-5">
  <h2 class="text-center mb-4">SẢN PHẨM NỔI BẬT</h2>
  <div class="row g-4">
    <% if (featuredProducts && featuredProducts.length > 0) { %>
      <% featuredProducts.forEach(product => { %>
        <div class="col-6 col-md-3">
          <div class="card product-card h-100">
            <div class="position-relative">
              <a href="/products/<%= product.slug %>">
                <img src="<%= product.images && product.images.length > 0 ? '/uploads/products/' + product.images[0] : 'https://via.placeholder.com/300?text=No+Image' %>" class="card-img-top" alt="<%= product.name %>">
              </a>
              
              <% if (product.discountPrice && product.discountPrice > 0 && product.discountPrice < product.price) { %>
                <span class="badge bg-danger position-absolute top-0 start-0 m-2">
                  -<%= Math.round((1 - product.discountPrice / product.price) * 100) %>%
                </span>
              <% } %>
              
              <div class="wishlist-icon <%= user && user.wishlist && user.wishlist.includes(product._id) ? 'active' : '' %>"
                   data-product-id="<%= product._id %>"
                   data-logged-in="<%= user ? 'true' : 'false' %>">
                <i class="<%= user && user.wishlist && user.wishlist.includes(product._id) ? 'fas' : 'far' %> fa-heart"></i>
              </div>
            </div>
            
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="card-title mb-0"><a href="/products/<%= product.slug %>" class="text-decoration-none text-dark"><%= product.name %></a></h5>
                <span class="badge bg-success">NEW</span>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <% if (product.discountPrice && product.discountPrice > 0 && product.discountPrice < product.price) { %>
                    <span class="product-price"><%= product.discountPrice.toLocaleString('vi-VN') %> ₫</span>
                    <span class="discount-price ms-2"><%= product.price.toLocaleString('vi-VN') %> ₫</span>
                  <% } else { %>
                    <span class="product-price"><%= product.price.toLocaleString('vi-VN') %> ₫</span>
                  <% } %>
                </div>
                <div class="product-rating">
                  <% 
                    // Calculate rating directly from reviews if available
                    const rating = product.reviews && product.reviews.length > 0 
                      ? product.reviews.reduce((sum, review) => sum + review.rating, 0) / product.reviews.length 
                      : 0;
                    const numReviews = product.reviews ? product.reviews.length : 0;
                  %>
                  
                  <%# Use the renderStars helper if defined, otherwise inline stars %>
                  <% if (typeof renderStars === 'function') { %>
                    <%- renderStars(rating) %>
                  <% } else { %>
                    <% for (let i = 1; i <= 5; i++) { %>
                      <% if (i <= Math.round(rating)) { %>
                        <i class="fas fa-star text-warning"></i>
                      <% } else { %>
                        <i class="far fa-star text-warning"></i>
                      <% } %>
                    <% } %>
                  <% } %>
                  
                  <small class="text-muted">(<%= numReviews %>)</small>
                </div>
              </div>
            </div>
            <div class="card-footer bg-white border-top-0">
              <div class="d-grid">
                <a href="/products/<%= product.slug %>" class="btn btn-outline-primary">Xem chi tiết</a>
              </div>
            </div>
          </div>
        </div>
      <% }); %>
    <% } else { %>
      <div class="col-12 text-center">
        <p>Không có sản phẩm nổi bật</p>
      </div>
    <% } %>
  </div>
  <div class="text-center mt-4">
    <a href="/products?featured=true" class="btn btn-outline-dark">Xem tất cả</a>
  </div>
</section>

<!-- New Arrivals -->
<section class="container mb-5">
  <h2 class="text-center mb-4">HÀNG MỚI VỀ</h2>
  <div class="row g-4">
    <% if (newArrivals && newArrivals.length > 0) { %>
      <% newArrivals.forEach(product => { %>
        <div class="col-6 col-md-3">
          <div class="card product-card h-100">
            <div class="position-relative">
              <a href="/products/<%= product.slug %>">
                <img src="<%= product.images && product.images.length > 0 ? '/uploads/products/' + product.images[0] : 'https://via.placeholder.com/300?text=No+Image' %>" class="card-img-top" alt="<%= product.name %>">
              </a>
              
              <% if (product.discountPrice && product.discountPrice > 0 && product.discountPrice < product.price) { %>
                <span class="badge bg-danger position-absolute top-0 start-0 m-2">
                  -<%= Math.round((1 - product.discountPrice / product.price) * 100) %>%
                </span>
              <% } %>
              
              <div class="wishlist-icon <%= user && user.wishlist && user.wishlist.includes(product._id) ? 'active' : '' %>"
                   data-product-id="<%= product._id %>"
                   data-logged-in="<%= user ? 'true' : 'false' %>"
                   style="z-index: 3;">
                <i class="<%= user && user.wishlist && user.wishlist.includes(product._id) ? 'fas' : 'far' %> fa-heart"></i>
              </div>
            </div>
            
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="card-title mb-0"><a href="/products/<%= product.slug %>" class="text-decoration-none text-dark"><%= product.name %></a></h5>
                <span class="badge bg-success">NEW</span>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <% if (product.discountPrice && product.discountPrice > 0 && product.discountPrice < product.price) { %>
                    <span class="product-price"><%= product.discountPrice.toLocaleString('vi-VN') %> ₫</span>
                    <span class="discount-price ms-2"><%= product.price.toLocaleString('vi-VN') %> ₫</span>
                  <% } else { %>
                    <span class="product-price"><%= product.price.toLocaleString('vi-VN') %> ₫</span>
                  <% } %>
                </div>
                <div class="product-rating">
                  <% 
                    // Calculate rating directly from reviews if available
                    const rating = product.reviews && product.reviews.length > 0 
                      ? product.reviews.reduce((sum, review) => sum + review.rating, 0) / product.reviews.length 
                      : 0;
                    const numReviews = product.reviews ? product.reviews.length : 0;
                  %>
                  
                  <%# Use the renderStars helper if defined, otherwise inline stars %>
                  <% if (typeof renderStars === 'function') { %>
                    <%- renderStars(rating) %>
                  <% } else { %>
                    <% for (let i = 1; i <= 5; i++) { %>
                      <% if (i <= Math.round(rating)) { %>
                        <i class="fas fa-star text-warning"></i>
                      <% } else { %>
                        <i class="far fa-star text-warning"></i>
                      <% } %>
                    <% } %>
                  <% } %>
                  
                  <small class="text-muted">(<%= numReviews %>)</small>
                </div>
              </div>
            </div>
            <div class="card-footer bg-white border-top-0">
              <div class="d-grid">
                <a href="/products/<%= product.slug %>" class="btn btn-outline-primary">Xem chi tiết</a>
              </div>
            </div>
          </div>
        </div>
      <% }); %>
    <% } else { %>
      <div class="col-12 text-center">
        <p>Không có sản phẩm mới</p>
      </div>
    <% } %>
  </div>
  <div class="text-center mt-4">
    <a href="/products?sort=createdAt&order=desc" class="btn btn-outline-dark">Xem tất cả</a>
  </div>
</section>

<!-- Best Sellers -->
<section class="container mb-5">
  <h2 class="text-center mb-4">SẢN PHẨM BÁN CHẠY</h2>
  <div class="row g-4">
    <% if (bestSellers && bestSellers.length > 0) { %>
      <% bestSellers.forEach(product => { %>
        <div class="col-6 col-md-3">
          <div class="card product-card h-100">
            <div class="position-relative">
              <a href="/products/<%= product.slug %>">
                <img src="<%= product.images && product.images.length > 0 ? '/uploads/products/' + product.images[0] : 'https://via.placeholder.com/300?text=No+Image' %>" class="card-img-top" alt="<%= product.name %>" style="height: 200px; object-fit: cover;">
              </a>
              
              <% if (product.discountPrice && product.discountPrice > 0 && product.discountPrice < product.price) { %>
                <span class="badge bg-danger position-absolute top-0 start-0 m-2">
                  -<%= Math.round((1 - product.discountPrice / product.price) * 100) %>%
                </span>
              <% } %>
              
              <div class="wishlist-icon <%= user && user.wishlist && user.wishlist.includes(product._id) ? 'active' : '' %>"
                   data-product-id="<%= product._id %>"
                   data-logged-in="<%= user ? 'true' : 'false' %>"
                   style="z-index: 3;">
                <i class="<%= user && user.wishlist && user.wishlist.includes(product._id) ? 'fas' : 'far' %> fa-heart"></i>
              </div>
            </div>
            
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="card-title mb-0"><a href="/products/<%= product.slug %>" class="text-decoration-none text-dark"><%= product.name %></a></h5>
                <span class="badge bg-warning">HOT</span>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <% if (product.discountPrice && product.discountPrice > 0 && product.discountPrice < product.price) { %>
                    <span class="product-price"><%= product.discountPrice.toLocaleString('vi-VN') %> ₫</span>
                    <span class="discount-price ms-2"><%= product.price.toLocaleString('vi-VN') %> ₫</span>
                  <% } else { %>
                    <span class="product-price"><%= product.price.toLocaleString('vi-VN') %> ₫</span>
                  <% } %>
                </div>
                <div class="product-rating">
                  <% 
                    // Calculate rating directly from reviews if available
                    const rating = product.reviews && product.reviews.length > 0 
                      ? product.reviews.reduce((sum, review) => sum + review.rating, 0) / product.reviews.length 
                      : 0;
                    const numReviews = product.reviews ? product.reviews.length : 0;
                  %>
                  
                  <%# Use the renderStars helper if defined, otherwise inline stars %>
                  <% if (typeof renderStars === 'function') { %>
                    <%- renderStars(rating) %>
                  <% } else { %>
                    <% for (let i = 1; i <= 5; i++) { %>
                      <% if (i <= Math.round(rating)) { %>
                        <i class="fas fa-star text-warning"></i>
                      <% } else { %>
                        <i class="far fa-star text-warning"></i>
                      <% } %>
                    <% } %>
                  <% } %>
                  
                  <small class="text-muted">(<%= numReviews %>)</small>
                </div>
              </div>
            </div>
            <div class="card-footer bg-white border-top-0">
              <div class="d-grid">
                <a href="/products/<%= product.slug %>" class="btn btn-outline-primary">Xem chi tiết</a>
              </div>
            </div>
          </div>
        </div>
      <% }); %>
    <% } else { %>
      <div class="col-12 text-center">
        <p>Không có sản phẩm bán chạy</p>
      </div>
    <% } %>
  </div>
  <div class="text-center mt-4">
    <a href="/products?sort=sold&order=desc" class="btn btn-outline-dark">Xem tất cả</a>
  </div>
</section>

<!-- Features -->
<section class="container mb-5 py-5 bg-light">
  <div class="row g-4">
    <div class="col-md-3 text-center">
      <div class="p-3">
        <i class="fas fa-truck fa-3x mb-3 text-primary"></i>
        <h5>GIAO HÀNG MIỄN PHÍ</h5>
        <p class="text-muted">Cho đơn hàng từ 1.000.000đ</p>
      </div>
    </div>
    <div class="col-md-3 text-center">
      <div class="p-3">
        <i class="fas fa-undo fa-3x mb-3 text-primary"></i>
        <h5>ĐỔI TRẢ DỄ DÀNG</h5>
        <p class="text-muted">Trong vòng 30 ngày</p>
      </div>
    </div>
    <div class="col-md-3 text-center">
      <div class="p-3">
        <i class="fas fa-shield-alt fa-3x mb-3 text-primary"></i>
        <h5>THANH TOÁN AN TOÀN</h5>
        <p class="text-muted">Bảo mật thông tin</p>
      </div>
    </div>
    <div class="col-md-3 text-center">
      <div class="p-3">
        <i class="fas fa-headset fa-3x mb-3 text-primary"></i>
        <h5>HỖ TRỢ 24/7</h5>
        <p class="text-muted">Hotline: 0123 456 789</p>
      </div>
    </div>
  </div>
</section>

<!-- Newsletter -->
<section class="container mb-5">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="p-4 text-center" style="background-color: #f8f9fa; border-radius: 10px;">
        <h3>ĐĂNG KÝ NHẬN TIN</h3>
        <p class="text-muted">Đăng ký để nhận thông tin về sản phẩm mới và khuyến mãi đặc biệt</p>
        <form class="row g-3 justify-content-center">
          <div class="col-md-8">
            <input type="email" class="form-control" placeholder="Email của bạn" required>
          </div>
          <div class="col-md-auto">
            <button type="submit" class="btn btn-primary">Đăng ký</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<a id="back-to-top" class="back-to-top"><i class="fas fa-arrow-up"></i></a>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Wishlist functionality
    const wishlistButtons = document.querySelectorAll('.wishlist-icon');
    
    wishlistButtons.forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Kiểm tra đăng nhập dựa vào data attribute
        const isLoggedIn = this.getAttribute('data-logged-in') === 'true';
        if (!isLoggedIn) {
          // If not logged in, redirect to login
          window.location.href = '/users/login';
          return;
        }
        
        const productId = this.dataset.productId;
        const isInWishlist = this.classList.contains('active');
        const method = isInWishlist ? 'DELETE' : 'POST';
        
        fetch(`/api/users/wishlist/${productId}`, {
          method: method,
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Toggle active state
            this.classList.toggle('active');
            
            // Update icon
            const icon = this.querySelector('i');
            if (icon) {
              icon.className = isInWishlist ? 'far fa-heart' : 'fas fa-heart';
            }
            
            // Show toast notification
            if (window.showToast) {
              window.showToast(data.message);
            }
          } else {
            if (window.showToast) {
              window.showToast(data.message, 'error');
            }
          }
        })
        .catch(error => {
          console.error('Error:', error);
          if (window.showToast) {
            window.showToast('Có lỗi xảy ra, vui lòng thử lại sau', 'error');
          }
        });
      });
    });
  });
</script> 